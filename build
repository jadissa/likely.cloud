#!/bin/bash
#
# ________                              .____                    .___
# \______ \_______  ____ _____    _____ |    |    ____  __ __  __| _/
#  |    |  \_  __ _/ __ \\__  \  /     \|    |   /  _ \|  |  \/ __ | 
#  |    `   |  | \\  ___/ / __ \|  Y Y  |    |__(  <_> |  |  / /_/ | 
# /_______  |__|   \___  (____  |__|_|  |_______ \____/|____/\____ | 
#         \/           \/     \/      \/        \/                \/ 
#
#                                                              © 2017

#https://www.digitalocean.com/community/tutorials/how-to-set-up-a-node-js-application-for-production-on-centos-7

#
# Load
#
. /etc/os-release

ID=$ID

VER=$VERSION_ID

PROJECTPATH=/var/www/html

PRIVATE_IP_ADDRESS=`curl -w "\n" http://169.254.169.254/metadata/v1/interfaces/private/0/ipv4/address`

GROUP=www

USER=www

_init() {

    echo ' ________                              .____                    .___'

    echo '\______ \_______  ____ _____    _____ |    |    ____  __ __  __| _/'

    echo ' |    |  \_  __ _/ __ \\__  \  /     \|    |   /  _ \|  |  \/ __ |'

    echo ' |    `   |  | \\  ___/ / __ \|  Y Y  |    |__(  <_> |  |  / /_/ |'

    echo '/_______  |__|   \___  (____  |__|_|  |_______ \____/|____/\____ |'

    echo '        \/           \/     \/      \/        \/                \/'

    echo 

    echo '                                                              © 2017'

    echo 'This script will check for needed configurations per run'

    echo 'Create the following:'

    echo 'Project directory:    /var/www/html'

    echo 'Group:                www'

    echo 'User:                 www'

    USER=`whoami`

    if [ "$USER" != "root" ]; then

        echo 'You must run this script as root'

        exit 1

    fi

    echo 'Do you agree?'

    echo 'OK, Y/N'

    read CHOICE

    if [ "$CHOICE" != "Y" ]; then

        echo 'Exiting...'

        exit 1

    fi

    if [ "$ID" != "centos" ] || [ "$VER" != "7" ]; then

        echo 'CentOS 7 required, exiting...'

        exit 1

    fi

}

_group_mod() {

    GROUP_EXISTS=`cat /etc/group | grep $GROUP`

    if [ "$GROUP_EXISTS" == "" ]; then

        sudo groupadd $GROUP

        sudo useradd $GROUP -g wheel

    fi

}

_update() {

    #
    # Get dependencies
    #
    echo 'Installing preliminary updates...'

    cd /tmp

    sudo yum -y update

    sudo yum -y install nginx wget http-server libicu-dev epel-release policycoreutils-python net-tools git vim mlocate

    sudo yum -y groupinstall 'Development Tools'

    sudo yum -y install gcc-c++ make

    sudo curl -sL https://rpm.nodesource.com/setup_8.x | sudo -E bash -

    sudo yum install -y nodejs

    which node

    node -v

    npm -v

    sudo npm install -g forever

    sudo systemctl start nginx

    sudo systemctl enable nginx

    sudo npm install -g pm2@latest -g http-server

    sudo wget https://dl.yarnpkg.com/rpm/yarn.repo -O /etc/yum.repos.d/yarn.repo

    echo "Configuring $PROJECTPATH..."

    sudo mkdir -p $PROJECTPATH

    echo "export PATH=$PROJECTPATH:$PATH" >>~/.bashrc

    source ~/.bashrc

    sudo chmod -R 0775 $PROJECTPATH

    sudo chown -R $USER:wheel $PROJECTPATH

    #
    # Checkout project
    #
    # Our project already exists so, not adding here 

    stat -c "Rights: %A Perms: %a Username:Owner: %U:%G File: %n Type: %F Bytes: %s" $PROJECTPATH

    cd $PROJECTPATH

    #
    # Install node dependencies 
    #
    if [ -f ./package.json ]; then

        sudo yarn install

        sudo yarn upgrade

    else 

        sudo yum -y install yarn

        sudo yarn install

    fi

    files=(./node_modules/geoip-lite/tmp/*)

    if [ ! -e "${files[0]}" ]; then 
        
        cd node_modules/geoip-lite/

        npm run-script updatedb

        cd $PROJECTPATH

    fi

}

_pm2() {

    #
    # Manage pm2
    #
    PM2PROCESSLIST=`pm2 jlist`
    
    PROCESSNAME=`pm2 id discord-token-generator`

    if [ "$PROCESSNAME" != "discord-token-generator" ]; then

    #    mkdir -p $PROJECTPATH/.pm2/logs

    #    sudo chown -R root:$USER $PROJECTPATH/.pm2/logs

    #    sudo pm2 --log $PROJECTPATH/.pm2/logs --output $PROJECTPATH/.pm2/logs/output.log --error $PROJECTPATH/.pm2/logs/error.log --pid $PROJECTPATH/.pm2/p.id logrotate tart node_modules/discord-token-generator/server.js --name discord-token-generator

        pm2 start

        pm2 ls

        pm2 save

        sudo chown -R $GROUP:$USER ~/.pm2

        pkill -f PM2

        pm2 delete all

        pm2 resurrect

    else

        pm2 ls 

        pm2 logs --nostream

        #pm2 logs

    fi

}



_nginx() {

    #
    # Configure nginx
    #
    if [ ! -d /etc/nginx/conf.d/ ]; then

        sudo mkdir /etc/nginx/conf.d/ 

    fi

    WORKER_PROCESS=`sudo grep -c 'model name' /proc/cpuinfo`

    sudo cat << EOF > /etc/nginx/nginx.conf
    worker_processes  ${WORKER_PROCESS};

    pid        /run/nginx.pid;

    events {
        worker_connections  1024;
    }

    http {

        ##
        # Basic Settings
        ##
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        ##
        # Logging Settings
        ##
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        ##
        # Gzip Settings
        ##
        gzip on;
        gzip_disable "msie6";

        include /etc/nginx/conf.d/*.conf;

        server {
            listen 80 default_server;
            listen [::]:80 default_server;
            server_name _;

            root /usr/share/nginx/html;

            location / {
            }

        }

    }
    EOF

    sudo cat << EOF > /etc/nginx/conf.d/likely.conf
    server {
        listen 80;
        listen [::]:80;
        server_name likely.cloud;

        location / {
            proxy_pass "http://localhost:50451/";
        }

    }
    EOF

    sudo nginx -t

    sudo chmod -R 0766 /var/log/nginx

    sudo chown -R nginx:nginx /var/log/nginx

    sudo touch /run/nginx.pid

    sudo chown nginx:nginx /run/nginx.pid

    PRIVATE_IP_ADDRESS=`curl -s -w "\n" http://169.254.169.254/metadata/v1/interfaces/private/0/ipv4/address`

    sudo systemctl restart nginx

    sudo cat /etc/nginx/nginx.conf

    sudo cat /var/log/nginx/error.log

    sudo setenforce Permissive

    sudo chcon -Rt httpd_sys_content_t $PROJECTPATH

    sudo setenforce Enforcing

    setsebool -P httpd_can_network_connect true solved my issue

    sudo systemctl restart nginx

}

_mongodb() {

    sudo cat << EOF > /etc/yum.repos.d/mongodb-org.repo
    [mongodb-org-3.4]
    name=MongoDB Repository
    baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/
    gpgcheck=1
    enabled=1
    gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc
    EOF

    sudo yum repolist

    sudo yum -y install mongodb-org

    sudo systemctl start mongod

    mongod --port 27017 --dbpath /var/lib/mongo

}

_tests() {

    #
    # Globally install react for UI
    #
    #cd $PROJECTPATH

    #sudo npm install -g react-composer create-react-app

    #create-react-app app

    netstat -tln

    pm2 status

    sudo nginx -t

    curl http://$PRIVATE_IP_ADDRESS:8080

    sudo systemctl status nginx

    sudo systemctl status mongodb

}

fun() {

    _init

    _group_mod

    _update

    _pm2

    _nginx

    _mongodb

    _tests

}

fun